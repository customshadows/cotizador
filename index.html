<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Pro | Custom Shadows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwb6vK_hwvCCBXRAdtIFH0WLG4GbSygBA",
            authDomain: "cotizador-shadows-e544b.firebaseapp.com",
            projectId: "cotizador-shadows-e544b",
            storageBucket: "cotizador-shadows-e544b.firebasestorage.app",
            messagingSenderId: "174933464686",
            appId: "1:174933464686:web:fe03d5369f2fd5bc6bb87f",
            measurementId: "G-DHW5LGS8VV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 500: '#0ea5e9', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background: #f1f5f9; font-family: 'Outfit', sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .input-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
        .modern-input { width: 100%; padding: 10px; border: 2px solid #f1f5f9; border-radius: 8px; transition: all 0.2s; font-size: 0.95rem; font-weight: 500; }
        .modern-input:focus { border-color: #0ea5e9; outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .btn-primary { background: #0c4a6e; color: white; transition: all 0.2s; cursor: pointer; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn-primary:hover { background: #075985; transform: translateY(-1px); }
        .table-header { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; border-bottom: 2px solid #f1f5f9; padding: 12px; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } #pdf-area { margin: 0; padding: 0; border: none; box-shadow: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        
        <div class="no-print card bg-slate-850 p-4 mb-8 flex flex-col md:flex-row items-center justify-between gap-4 border-none">
            <div class="flex items-center gap-4">
                <div class="h-10 w-10 bg-brand-500 rounded-lg flex items-center justify-center text-white font-black">CS</div>
                <div>
                    <h2 class="text-white font-bold text-sm tracking-tight">Gestor de Cotizaciones</h2>
                    <p class="text-brand-500 text-[10px] uppercase font-bold">Base de datos Activa</p>
                </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <select id="historial-select" onchange="cargarDesdeDB(this.value)" class="bg-slate-800 text-white text-xs p-3 rounded-lg border border-slate-700 w-full outline-none">
                    <option value="">Historial reciente...</option>
                </select>
                <button onclick="nuevaCotizacion()" class="bg-white/10 hover:bg-white/20 text-white text-[10px] px-4 rounded-lg font-bold transition-all">NUEVO</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6 no-print">
                <div class="card p-6">
                    <h3 class="text-slate-900 font-bold mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-4 bg-brand-500 rounded-full"></span> 1. Datos del Proyecto
                    </h3>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label>Nombre del Cliente</label>
                            <input type="text" id="cliente" oninput="render()" class="modern-input" placeholder="Ej. Juan Pérez">
                        </div>
                        <div class="input-group">
                            <label>Teléfono de Contacto</label>
                            <input type="text" id="tel-cliente" oninput="render()" class="modern-input" placeholder="999 000 0000">
                        </div>
                        <div class="input-group">
                            <label>Ubicación / Obra</label>
                            <input type="text" id="direccion" oninput="render()" class="modern-input" placeholder="Fracc. o Colonia">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-slate-900 font-bold mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-4 bg-brand-500 rounded-full"></span> 2. Añadir Producto
                    </h3>
                    <div class="space-y-4">
                        <select id="categoria" onchange="cargarTelas()" class="modern-input">
                            <option value="">Seleccione Sistema</option>
                            <option value="ENROLLABLES">Enrollables</option>
                            <option value="SHEER">Sheer Elegance</option>
                        </select>
                        <select id="modelo" class="modern-input text-xs font-bold uppercase"></select>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="ambiente" placeholder="Ambiente" class="modern-input">
                            <input type="text" id="color" placeholder="Color" class="modern-input">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" id="ancho" step="0.01" placeholder="Ancho" class="modern-input text-center">
                            <input type="number" id="alto" step="0.01" placeholder="Alto" class="modern-input text-center">
                            <input type="number" id="cantidad" value="1" placeholder="Cant" class="modern-input text-center font-bold">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg space-y-3">
                            <input type="number" id="motor-precio" placeholder="Precio Motor ($)" class="modern-input">
                            <label class="flex items-center gap-2 text-[11px] font-bold text-slate-600 uppercase cursor-pointer">
                                <input type="checkbox" id="facia-toggle" class="w-4 h-4 accent-brand-500"> Incluir Facia (Caja)
                            </label>
                        </div>
                        <button onclick="agregar()" class="w-full btn-primary py-4 text-xs">Añadir a la lista</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="no-print flex gap-4">
                    <button onclick="guardarEnDB()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-xl font-bold text-xs uppercase shadow-lg transition-all">Guardar en Nube</button>
                    <button onclick="generarPDF()" class="flex-1 bg-brand-700 hover:bg-brand-800 text-white p-4 rounded-xl font-bold text-xs uppercase shadow-lg transition-all">Descargar PDF</button>
                </div>

                <div id="pdf-area" class="card bg-white p-8 md:p-12 overflow-hidden border-none shadow-2xl">
                    <div class="flex justify-between items-start mb-10 pb-8 border-b-2 border-slate-50">
                        <div class="flex gap-6 items-center">
                            <img src="https://raw.githubusercontent.com/customshadows/cotizador/main/logo%20custom%20shadows.jpg" class="h-20 w-20 object-contain">
                            <div>
                                <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter">Custom Shadows</h1>
                                <p class="text-slate-400 font-bold text-xs uppercase tracking-widest">Premium Window Coverings</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-brand-500 uppercase">Cotización</p>
                            <h2 id="folio-display" class="text-3xl font-black text-slate-900">#000</h2>
                            <p id="fecha-actual" class="text-[10px] text-slate-400 font-bold uppercase"></p>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-xl p-6 mb-10 grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Para:</span>
                            <h3 id="pdf-cliente" class="text-xl font-bold text-slate-800 uppercase">Nombre Cliente</h3>
                        </div>
                        <div class="text-right">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Lugar:</span>
                            <p id="pdf-direccion" class="text-slate-600 font-medium italic"></p>
                        </div>
                    </div>

                    <table class="w-full mb-10">
                        <thead>
                            <tr class="table-header">
                                <th class="text-left py-4">Descripción</th>
                                <th class="text-center py-4">Medidas</th>
                                <th class="text-center py-4">Cant</th>
                                <th class="text-right py-4">Subtotal</th>
                                <th class="no-print w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="lista" class="divide-y divide-slate-100"></tbody>
                    </table>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 pt-8 border-t-4 border-slate-900">
                        <div class="space-y-6">
                            <div class="bg-brand-50 p-4 rounded-lg border-l-4 border-brand-500">
                                <h4 class="text-[10px] font-black text-brand-700 uppercase mb-2">Resumen de Pago</h4>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-slate-600">Anticipo (50%)</span>
                                    <span id="val-anticipo" class="text-lg font-black text-slate-900">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-400">Saldo a Entrega</span>
                                    <span id="val-saldo" class="text-lg font-bold text-slate-400">$0.00</span>
                                </div>
                            </div>
                            <div class="text-[9px] text-slate-400 leading-relaxed uppercase font-bold space-y-1">
                                <p>• Garantía de 1 año en defectos de fábrica</p>
                                <p>• Tiempo de entrega: 8 a 12 días hábiles</p>
                                <p>• Vigencia de precios: 15 días</p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between px-2 text-sm font-bold text-slate-500">
                                <span>Bruto</span>
                                <span id="val-subtotal">$0.00</span>
                            </div>
                            <div id="desc-row" class="flex justify-between px-2 text-sm font-bold text-emerald-600 hidden">
                                <span>Descuento Aplicado</span>
                                <span id="val-desc-money">-$0.00</span>
                            </div>
                            <div class="flex justify-between items-center px-4 py-6 bg-slate-900 rounded-2xl text-white">
                                <span class="text-xs font-bold uppercase tracking-widest">Total Neto</span>
                                <span id="granTotal" class="text-4xl font-black tracking-tighter">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let folioActual = 1, idDocumentoActual = null, descuentoActual = 0, carrito = [];
const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

const DATA_ENROLLABLES = {
    "BLACK OUT": { "Long Beach": 810.39, "Texture": 937.44, "Ipanema": 910.88, "Ohio": 927.05, "Montreal": 991.73, "Budelli": 948.99, "Sydney": 1122.24, "Luxury": 1072.58, "B.O. 500": 1118.78, "Galaxy": 1169.60, "Stylus": 1297.80 },
    "FILTRO LIGERO": { "Long Beach": 748.65, "Cadiz": 783.83, "Ipanema": 806.93, "Budelli": 818.48, "Sydney": 933.98, "F. L. Fresh": 1049.48 },
    "SCREEN": { "Screen Basic": 810.39, "Screen Soft": 810.39, "Screen Millan": 962.85, "Screen One": 1058.72 }
};
const DATA_SHEER = {
    "DUOLINE": { "Basic": 995.19, "Aromy": 1041.39, "Viewty": 1071.42, "Aquamarine": 1018.92, "Woodline": 1226.19, "Celebrity": 1268.93, "Bright": 1285.10, "Radiance": 1436.40, "Terra": 1459.50, "Season": 1575.00 },
    "DUO DIM OUT": { "Dim Out": 1609.65, "Brave": 1973.09, "Genius Dim Out": 1973.09, "Dim Out Woods": 1921.50, "Royal Dim Out": 2037.00, "Glam Dim Out": 2071.65, "Lino Dim Out": 2152.50 }
};

function cargarTelas() {
    const s = document.getElementById('categoria').value, sel = document.getElementById('modelo');
    sel.innerHTML = '<option value="">Seleccione Tela</option>';
    let f = s === "ENROLLABLES" ? DATA_ENROLLABLES : (s === "SHEER" ? DATA_SHEER : null);
    if(f) Object.keys(f).forEach(g => {
        let gr = document.createElement('optgroup'); gr.label = g;
        Object.keys(f[g]).forEach(t => {
            let o = document.createElement('option'); o.value = f[g][t]; o.text = `${t} (${formatter.format(f[g][t])})`;
            o.setAttribute('data-full', `${g} - ${t}`); gr.appendChild(o);
        }); sel.appendChild(gr);
    });
}

function agregar() {
    const m = document.getElementById('modelo'); if(!m.value) return;
    const an = parseFloat(document.getElementById('ancho').value) || 0, al = parseFloat(document.getElementById('alto').value) || 0, ct = parseInt(document.getElementById('cantidad').value) || 1;
    const mot = parseFloat(document.getElementById('motor-precio').value) || 0, fc = document.getElementById('facia-toggle').checked;
    let m2 = (an * al) < 1 ? 1 : (an * al), cf = fc ? (an * 280) : 0, sub = ((m2 * parseFloat(m.value)) + mot + cf) * ct;
    carrito.push({
        amb: document.getElementById('ambiente').value || "Gral",
        nom: m.options[m.selectedIndex].getAttribute('data-full'),
        col: document.getElementById('color').value || "S/C",
        med: `${an.toFixed(2)}x${al.toFixed(2)}`, ct, sub, det: `${fc ? '[Facia]' : ''} ${mot>0 ? '[Mot]' : ''}`
    });
    render();
}

function render() {
    document.getElementById('pdf-cliente').innerText = document.getElementById('cliente').value || "PÚBLICO GENERAL";
    document.getElementById('pdf-direccion').innerText = document.getElementById('direccion').value || "--";
    document.getElementById('folio-display').innerText = '#' + String(folioActual).padStart(3, '0');
    document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
    const l = document.getElementById('lista'); l.innerHTML = ''; let sum = 0;
    carrito.forEach((it, i) => {
        sum += it.sub;
        l.innerHTML += `<tr class="text-slate-700"><td class="py-4"><div class="font-bold text-slate-900">${it.amb}</div><div class="text-[10px] text-slate-400 uppercase font-black">${it.nom} | ${it.col} ${it.det}</div></td><td class="text-center font-bold text-xs">${it.med}</td><td class="text-center font-bold text-xs">${it.ct}</td><td class="text-right font-black text-slate-900">${formatter.format(it.sub)}</td><td class="no-print text-right"><button onclick="eliminar(${i})" class="text-red-300 hover:text-red-600 transition-all">✕</button></td></tr>`;
    });
    document.getElementById('val-subtotal').innerText = formatter.format(sum);
    document.getElementById('granTotal').innerText = formatter.format(sum);
    document.getElementById('val-anticipo').innerText = formatter.format(sum / 2);
    document.getElementById('val-saldo').innerText = formatter.format(sum / 2);
}

function eliminar(i) { carrito.splice(i, 1); render(); }

async function guardarEnDB() {
    if(carrito.length===0) return alert("Carrito vacío");
    const doc = { folio: folioActual, cliente: document.getElementById('cliente').value, tel: document.getElementById('tel-cliente').value, dir: document.getElementById('direccion').value, carrito, fecha: new Date().toISOString() };
    try {
        if(idDocumentoActual) await db.collection("cotizaciones").doc(idDocumentoActual).set(doc);
        else { const r = await db.collection("cotizaciones").add(doc); idDocumentoActual = r.id; }
        alert("Sincronizado con la nube"); listarHistorial();
    } catch(e) { alert("Error Firebase: Verifica las reglas"); }
}

async function listarHistorial() {
    const s = document.getElementById('historial-select');
    const snap = await db.collection("cotizaciones").orderBy("fecha", "desc").limit(10).get();
    s.innerHTML = '<option value="">Historial reciente...</option>';
    snap.forEach(d => {
        const o = document.createElement('option'); o.value = d.id;
        o.text = `#${String(d.data().folio).padStart(3,'0')} - ${d.data().cliente}`; s.appendChild(o);
    });
}

async function cargarDesdeDB(id) {
    if(!id) return; const d = await db.collection("cotizaciones").doc(id).get();
    if(d.exists) {
        const data = d.data(); idDocumentoActual = id; folioActual = data.folio;
        document.getElementById('cliente').value = data.cliente; document.getElementById('tel-cliente').value = data.tel;
        document.getElementById('direccion').value = data.dir; carrito = data.carrito; render();
    }
}

function nuevaCotizacion() { idDocumentoActual = null; carrito = []; folioActual++; render(); }
function generarPDF() { 
    const e = document.getElementById('pdf-area');
    html2pdf().set({ margin: 0.2, filename: 'Cotizacion.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter' }}).from(e).save();
}

window.onload = () => { listarHistorial(); render(); };
</script>
</body>
</html>
