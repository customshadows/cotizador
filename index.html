<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Pro | Custom Shadows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwb6vK_hwvCCBXRAdtIFH0WLG4GbSygBA",
            authDomain: "cotizador-shadows-e544b.firebaseapp.com",
            projectId: "cotizador-shadows-e544b",
            storageBucket: "cotizador-shadows-e544b.firebasestorage.app",
            messagingSenderId: "174933464686",
            appId: "1:174933464686:web:fe03d5369f2fd5bc6bb87f",
            measurementId: "G-DHW5LGS8VV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 500: '#0ea5e9', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background: #f1f5f9; font-family: 'Outfit', sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .input-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
        .modern-input { width: 100%; padding: 10px; border: 2px solid #f1f5f9; border-radius: 8px; transition: all 0.2s; font-size: 0.85rem; font-weight: 500; }
        .modern-input:focus { border-color: #0ea5e9; outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .btn-primary { background: #0c4a6e; color: white; transition: all 0.2s; cursor: pointer; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn-primary:hover { background: #075985; transform: translateY(-1px); }
        .discount-btn { border: 1px solid #e2e8f0; font-size: 10px; font-weight: 700; padding: 6px; border-radius: 6px; transition: all 0.2s; color: #64748b; }
        .discount-btn.active { background: #0ea5e9; color: white; border-color: #0ea5e9; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } #pdf-area { margin: 0; padding: 0; border: none; box-shadow: none; } }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-6xl mx-auto">
        
        <div class="no-print card bg-slate-850 p-4 mb-6 flex flex-col md:flex-row items-center justify-between gap-4 border-none shadow-xl">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-brand-500 rounded-lg flex items-center justify-center text-white font-black text-xs">CS</div>
                <h2 class="text-white font-bold text-xs tracking-widest uppercase">Cloud Control Panel</h2>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <select id="historial-select" onchange="cargarDesdeDB(this.value)" class="bg-slate-800 text-white text-[10px] p-2 rounded-lg border border-slate-700 w-full outline-none">
                    <option value="">Cargando historial...</option>
                </select>
                <button onclick="nuevaCotizacion()" class="bg-white/10 hover:bg-white/20 text-white text-[10px] px-4 rounded-lg font-bold">LIMPIAR</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4 space-y-4 no-print">
                <div class="card p-5">
                    <h3 class="text-slate-900 text-xs font-black uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-1 h-3 bg-brand-500 rounded-full"></span> Proyecto
                    </h3>
                    <div class="grid grid-cols-1 gap-3">
                        <input type="text" id="cliente" oninput="render()" class="modern-input" placeholder="Nombre del Cliente">
                        <input type="text" id="tel-cliente" oninput="render()" class="modern-input" placeholder="WhatsApp / Tel">
                        <input type="text" id="direccion" oninput="render()" class="modern-input" placeholder="Ubicación de Obra">
                    </div>
                </div>

                <div class="card p-5">
                    <h3 class="text-slate-900 text-xs font-black uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-1 h-3 bg-brand-500 rounded-full"></span> Añadir Ítem
                    </h3>
                    <div class="space-y-3">
                        <select id="categoria" onchange="cargarTelas()" class="modern-input">
                            <option value="">Sistema...</option>
                            <option value="ENROLLABLES">Enrollables</option>
                            <option value="SHEER">Sheer Elegance</option>
                        </select>
                        <select id="modelo" class="modern-input text-[10px] font-bold uppercase"></select>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="ambiente" placeholder="Ambiente" class="modern-input">
                            <input type="text" id="color" placeholder="Color" class="modern-input">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" id="ancho" step="0.01" placeholder="Ancho" class="modern-input text-center font-bold text-brand-700">
                            <input type="number" id="alto" step="0.01" placeholder="Alto" class="modern-input text-center font-bold text-brand-700">
                            <input type="number" id="cantidad" value="1" class="modern-input text-center font-bold">
                        </div>
                        
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 space-y-2">
                            <input type="number" id="motor-precio" placeholder="Precio Motor $" class="modern-input">
                            <div class="flex gap-2">
                                <input type="text" id="extra-nombre" placeholder="Concepto Extra" class="modern-input w-2/3">
                                <input type="number" id="extra-precio" placeholder="$" class="modern-input w-1/3 text-center">
                            </div>
                            <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase cursor-pointer py-1">
                                <input type="checkbox" id="facia-toggle" class="w-4 h-4 accent-brand-500"> Agregar Facia
                            </label>
                        </div>
                        <button onclick="agregar()" class="w-full btn-primary py-3 text-[10px]">Añadir a la lista</button>
                    </div>
                </div>

                <div class="card p-5">
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Descuento Global</label>
                            <div class="grid grid-cols-4 gap-1">
                                <button onclick="setDiscount(0)" id="btn-0" class="discount-btn active">0%</button>
                                <button onclick="setDiscount(10)" id="btn-10" class="discount-btn">10%</button>
                                <button onclick="setDiscount(15)" id="btn-15" class="discount-btn">15%</button>
                                <button onclick="setDiscount(20)" id="btn-20" class="discount-btn">20%</button>
                            </div>
                        </div>
                        <div class="flex gap-3 items-end">
                            <div class="flex-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Instalación $</label>
                                <input type="number" id="inst" oninput="render()" class="modern-input font-bold" placeholder="0.00">
                            </div>
                            <label class="flex-1 border-2 border-slate-100 rounded-lg p-2 text-center text-[10px] font-bold uppercase cursor-pointer hover:bg-slate-50">
                                <input type="checkbox" id="iva-toggle" onchange="render()" class="accent-brand-500"> + IVA
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="no-print flex gap-4">
                    <button onclick="guardarEnDB()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-xl font-bold text-[10px] uppercase shadow-lg transition-all">Sincronizar Nube</button>
                    <button onclick="generarPDF()" class="flex-1 bg-brand-800 hover:bg-brand-900 text-white p-3 rounded-xl font-bold text-[10px] uppercase shadow-lg transition-all">Descargar PDF</button>
                </div>

                <div id="pdf-area" class="card bg-white p-10 md:p-14 border-none shadow-2xl relative">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-slate-50 rounded-bl-full -z-0 opacity-50"></div>

                    <div class="relative flex justify-between items-start mb-12 border-b-2 border-slate-100 pb-8">
                        <div class="flex gap-5">
                            <img src="https://raw.githubusercontent.com/customshadows/cotizador/main/logo%20custom%20shadows.jpg" class="h-16 w-16 object-contain rounded-full shadow-sm">
                            <div>
                                <h1 class="text-2xl font-black text-slate-900 tracking-tighter uppercase leading-none">Custom Shadows</h1>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-2">Cortinas y Persianas de Alta Gama</p>
                                <div class="mt-4 text-[8px] font-bold text-slate-400 space-y-0.5">
                                    <p>WhatsApp: 999 370 2007</p>
                                    <p>Email: customshadowsmx@gmail.com</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block bg-slate-900 text-white text-[9px] px-3 py-1 rounded-full font-bold mb-2 uppercase tracking-widest">Cotización Oficial</span>
                            <h2 id="folio-display" class="text-4xl font-black text-slate-900">#001</h2>
                            <p id="fecha-actual" class="text-[9px] text-brand-500 font-black uppercase mt-1"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-8 mb-10">
                        <div class="border-l-4 border-slate-900 pl-4">
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Cliente / Solicitante</span>
                            <p id="pdf-cliente" class="text-lg font-black text-slate-800 uppercase leading-tight">Público General</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Ubicación del Proyecto</span>
                            <p id="pdf-direccion" class="text-xs font-bold text-slate-600 uppercase italic">Mérida, Yucatán</p>
                            <p id="pdf-tel" class="text-[9px] text-slate-400 font-bold"></p>
                        </div>
                    </div>

                    <table class="w-full mb-10">
                        <thead class="bg-slate-900 text-white">
                            <tr class="text-[9px] uppercase tracking-widest font-black">
                                <th class="text-left p-3 rounded-l-lg">Descripción del Producto</th>
                                <th class="text-center p-3">Medidas</th>
                                <th class="text-center p-3">Cant</th>
                                <th class="text-right p-3 rounded-r-lg">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="lista" class="divide-y divide-slate-100 text-[11px] font-medium text-slate-700"></tbody>
                    </table>

                    <div class="grid grid-cols-5 gap-8">
                        <div class="col-span-3">
                            <div class="p-4 bg-slate-50 rounded-xl">
                                <h4 class="text-[9px] font-black text-slate-900 uppercase mb-3 border-b border-slate-200 pb-2">Condiciones Comerciales</h4>
                                <ul class="text-[8px] font-bold text-slate-500 uppercase space-y-2 tracking-widest">
                                    <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-brand-500 rounded-full"></span> Pago: 50% Anticipo / 50% Contra Entrega</li>
                                    <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-brand-500 rounded-full"></span> Tiempo: 8 a 12 días hábiles</li>
                                    <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-brand-500 rounded-full"></span> Garantía: 1 año por escrito</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-span-2 space-y-2">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                                <span>Subtotal</span> <span id="val-subtotal">$0.00</span>
                            </div>
                            <div id="desc-row" class="hidden flex justify-between text-[10px] font-black text-emerald-600 uppercase bg-emerald-50 px-2 py-1 rounded">
                                <span>Descuento</span> <span id="val-desc-money">-$0.00</span>
                            </div>
                            <div id="inst-row" class="hidden flex justify-between text-[10px] font-bold text-slate-500 uppercase">
                                <span>Instalación</span> <span id="val-inst-money">$0.00</span>
                            </div>
                            <div id="iva-row" class="hidden flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                                <span>IVA (16%)</span> <span id="val-iva">$0.00</span>
                            </div>
                            <div class="flex justify-between items-end pt-4 border-t-2 border-slate-900 mt-2">
                                <span class="text-[10px] font-black text-slate-900 uppercase">Total Neto</span>
                                <span id="granTotal" class="text-3xl font-black tracking-tighter text-slate-900">$0.00</span>
                            </div>
                            <div class="mt-4 pt-4 border-t border-dashed border-slate-200 grid grid-cols-2 text-[8px] font-black uppercase text-center gap-2">
                                <div class="bg-slate-50 p-2 rounded">
                                    <p class="text-slate-400 mb-1">Anticipo</p>
                                    <p id="val-anticipo" class="text-xs text-brand-700">$0.00</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded">
                                    <p class="text-slate-400 mb-1">Saldo</p>
                                    <p id="val-saldo" class="text-xs text-slate-700">$0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let folioActual = 1, idDocumentoActual = null, descuentoActual = 0, carrito = [];
const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

const DATA_ENROLLABLES = {
    "BLACK OUT": { "Long Beach": 810.39, "Texture": 937.44, "Ipanema": 910.88, "Ohio": 927.05, "Montreal": 991.73, "Budelli": 948.99, "Sydney": 1122.24, "Luxury": 1072.58, "B.O. 500": 1118.78, "Galaxy": 1169.60, "Stylus": 1297.80 },
    "FILTRO LIGERO": { "Long Beach": 748.65, "Cadiz": 783.83, "Ipanema": 806.93, "Budelli": 818.48, "Sydney": 933.98, "F. L. Fresh": 1049.48 },
    "SCREEN": { "Screen Basic": 810.39, "Screen Soft": 810.39, "Screen Millan": 962.85, "Screen One": 1058.72 }
};
const DATA_SHEER = {
    "DUOLINE": { "Basic": 995.19, "Aromy": 1041.39, "Viewty": 1071.42, "Aquamarine": 1018.92, "Woodline": 1226.19, "Celebrity": 1268.93, "Bright": 1285.10, "Radiance": 1436.40, "Terra": 1459.50, "Season": 1575.00 },
    "DUO DIM OUT": { "Dim Out": 1609.65, "Brave": 1973.09, "Genius Dim Out": 1973.09, "Dim Out Woods": 1921.50, "Royal Dim Out": 2037.00, "Glam Dim Out": 2071.65, "Lino Dim Out": 2152.50 }
};

function cargarTelas() {
    const s = document.getElementById('categoria').value, sel = document.getElementById('modelo');
    sel.innerHTML = '<option value="">Elegir Tela...</option>';
    let f = s === "ENROLLABLES" ? DATA_ENROLLABLES : (s === "SHEER" ? DATA_SHEER : null);
    if(f) Object.keys(f).forEach(g => {
        let gr = document.createElement('optgroup'); gr.label = g;
        Object.keys(f[g]).forEach(t => {
            let o = document.createElement('option'); o.value = f[g][t]; o.text = `${t} (${formatter.format(f[g][t])})`;
            o.setAttribute('data-full', `${g} - ${t}`); gr.appendChild(o);
        }); sel.appendChild(gr);
    });
}

function agregar() {
    const m = document.getElementById('modelo'); if(!m.value) return;
    const an = parseFloat(document.getElementById('ancho').value) || 0, al = parseFloat(document.getElementById('alto').value) || 0, ct = parseInt(document.getElementById('cantidad').value) || 1;
    const mot = parseFloat(document.getElementById('motor-precio').value) || 0;
    const extraN = document.getElementById('extra-nombre').value;
    const extraP = parseFloat(document.getElementById('extra-precio').value) || 0;
    const fc = document.getElementById('facia-toggle').checked;
    
    let m2 = (an * al) < 1 ? 1 : (an * al), cf = fc ? (an * 280) : 0;
    let sub = ((m2 * parseFloat(m.value)) + mot + cf + extraP) * ct;
    
    carrito.push({
        amb: document.getElementById('ambiente').value || "Gral",
        nom: m.options[m.selectedIndex].getAttribute('data-full'),
        col: document.getElementById('color').value || "S/C",
        med: `${an.toFixed(2)}x${al.toFixed(2)}`, ct, sub, 
        det: `${fc ? '[Facia]' : ''} ${mot>0 ? '[Motor]' : ''} ${extraN ? '['+extraN+']' : ''}`
    });
    render();
}

function setDiscount(val) {
    descuentoActual = val;
    document.querySelectorAll('.discount-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-'+val).classList.add('active');
    render();
}

function render() {
    document.getElementById('pdf-cliente').innerText = document.getElementById('cliente').value || "PÚBLICO GENERAL";
    document.getElementById('pdf-tel').innerText = document.getElementById('tel-cliente').value ? 'Tel: ' + document.getElementById('tel-cliente').value : "";
    document.getElementById('pdf-direccion').innerText = document.getElementById('direccion').value || "Mérida, Yucatán";
    document.getElementById('folio-display').innerText = '#' + String(folioActual).padStart(3, '0');
    document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
    
    const l = document.getElementById('lista'); l.innerHTML = ''; let sum = 0;
    carrito.forEach((it, i) => {
        sum += it.sub;
        l.innerHTML += `<tr><td class="p-3"><b>${it.amb}</b><br><span class="text-[9px] text-slate-400 uppercase font-black">${it.nom} | ${it.col} ${it.det}</span></td><td class="text-center font-bold">${it.med}</td><td class="text-center font-bold">${it.ct}</td><td class="text-right font-black text-slate-900">${formatter.format(it.sub)} <button onclick="eliminar(${i})" class="no-print ml-2 text-red-300 hover:text-red-500">✕</button></td></tr>`;
    });

    let mDesc = sum * (descuentoActual / 100);
    let subConDesc = sum - mDesc;
    let inst = parseFloat(document.getElementById('inst').value) || 0;
    let iva = document.getElementById('iva-toggle').checked ? (subConDesc + inst) * 0.16 : 0;
    let total = subConDesc + inst + iva;

    document.getElementById('val-subtotal').innerText = formatter.format(sum);
    document.getElementById('val-desc-money').innerText = `-${formatter.format(mDesc)}`;
    document.getElementById('desc-row').style.display = descuentoActual > 0 ? 'flex' : 'none';
    document.getElementById('val-inst-money').innerText = formatter.format(inst);
    document.getElementById('inst-row').style.display = inst > 0 ? 'flex' : 'none';
    document.getElementById('val-iva').innerText = formatter.format(iva);
    document.getElementById('iva-row').style.display = iva > 0 ? 'flex' : 'none';
    document.getElementById('granTotal').innerText = formatter.format(total);
    document.getElementById('val-anticipo').innerText = formatter.format(total / 2);
    document.getElementById('val-saldo').innerText = formatter.format(total / 2);
}

function eliminar(i) { carrito.splice(i, 1); render(); }

async function guardarEnDB() {
    if(carrito.length===0) return alert("Añade productos.");
    const doc = { 
        folio: folioActual, 
        cliente: document.getElementById('cliente').value || "PÚBLICO GENERAL",
        tel: document.getElementById('tel-cliente').value,
        dir: document.getElementById('direccion').value,
        inst: parseFloat(document.getElementById('inst').value) || 0,
        desc: descuentoActual,
        iva: document.getElementById('iva-toggle').checked,
        carrito, 
        fecha: new Date().toISOString() 
    };
    try {
        if(idDocumentoActual) await db.collection("cotizaciones").doc(idDocumentoActual).set(doc);
        else { const r = await db.collection("cotizaciones").add(doc); idDocumentoActual = r.id; }
        alert("Sincronizado con la nube"); listarHistorial();
    } catch(e) { alert("Error al guardar: Revisa reglas en Firebase"); }
}

async function listarHistorial() {
    const s = document.getElementById('historial-select');
    try {
        const snap = await db.collection("cotizaciones").orderBy("fecha", "desc").limit(10).get();
        s.innerHTML = '<option value="">Cargar cotización...</option>';
        snap.forEach(d => {
            const o = document.createElement('option'); o.value = d.id;
            o.text = `#${String(d.data().folio).padStart(3,'0')} - ${d.data().cliente}`; s.appendChild(o);
        });
    } catch(e) { s.innerHTML = '<option>Sin conexión</option>'; }
}

async function cargarDesdeDB(id) {
    if(!id) return; const d = await db.collection("cotizaciones").doc(id).get();
    if(d.exists) {
        const data = d.data(); idDocumentoActual = id; folioActual = data.folio;
        document.getElementById('cliente').value = data.cliente; 
        document.getElementById('tel-cliente').value = data.tel || "";
        document.getElementById('direccion').value = data.dir || "";
        document.getElementById('inst').value = data.inst || 0;
        document.getElementById('iva-toggle').checked = data.iva || false;
        carrito = data.carrito; 
        setDiscount(data.desc || 0);
        render();
    }
}

function nuevaCotizacion() { idDocumentoActual = null; carrito = []; folioActual++; render(); }
function generarPDF() { 
    const e = document.getElementById('pdf-area');
    const opt = { margin: 0.1, filename: `CS_${document.getElementById('cliente').value}.pdf`, html2canvas: { scale: 3 }, jsPDF: { unit: 'in', format: 'letter' }};
    html2pdf().set(opt).from(e).save();
}

window.onload = () => { listarHistorial(); render(); };
</script>
</body>
</html>
